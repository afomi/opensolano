<div id="budget-pie-chart" style="width: 100%; height: 400px;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Budget Allocation Pie Chart
(function() {
  // Sample data - replace with actual budget allocation data
  const data = [
    { category: 'Public Safety', amount: 180000000, color: '#dc2626' },
    { category: 'Education', amount: 220000000, color: '#2563eb' },
    { category: 'Infrastructure', amount: 95000000, color: '#16a34a' },
    { category: 'Health Services', amount: 85000000, color: '#ca8a04' },
    { category: 'Parks & Recreation', amount: 45000000, color: '#9333ea' },
    { category: 'Administration', amount: 55000000, color: '#dc2626' },
    { category: 'Economic Development', amount: 35000000, color: '#0891b2' },
    { category: 'Other', amount: 25000000, color: '#6b7280' }
  ];

  const container = d3.select("#budget-pie-chart");
  const containerNode = container.node();
  const containerWidth = containerNode.getBoundingClientRect().width;
  
  const width = containerWidth;
  const height = 400;
  const radius = Math.min(width, height) / 2 - 40;

  // Clear any existing content
  container.selectAll("*").remove();

  const svg = container.append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g")
    .attr("transform", `translate(${width/2}, ${height/2})`);

  // Calculate total for percentages
  const total = d3.sum(data, d => d.amount);

  // Color scale
  const color = d3.scaleOrdinal()
    .domain(data.map(d => d.category))
    .range(data.map(d => d.color));

  // Pie generator
  const pie = d3.pie()
    .value(d => d.amount)
    .sort(null);

  // Arc generator
  const arc = d3.arc()
    .innerRadius(0)
    .outerRadius(radius);

  // Arc generator for labels
  const labelArc = d3.arc()
    .innerRadius(radius + 10)
    .outerRadius(radius + 10);

  // Create arcs
  const arcs = g.selectAll(".arc")
    .data(pie(data))
    .enter().append("g")
    .attr("class", "arc");

  // Draw pie slices
  arcs.append("path")
    .attr("d", arc)
    .attr("fill", d => color(d.data.category))
    .attr("stroke", "white")
    .attr("stroke-width", 2)
    .on("mouseover", function(event, d) {
      d3.select(this)
        .transition()
        .duration(200)
        .attr("transform", function() {
          const centroid = arc.centroid(d);
          return `translate(${centroid[0] * 0.1}, ${centroid[1] * 0.1})`;
        });

      const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("background", "rgba(0,0,0,0.8)")
        .style("color", "white")
        .style("padding", "12px")
        .style("border-radius", "4px")
        .style("font-size", "14px")
        .style("pointer-events", "none")
        .html(`
          <strong>${d.data.category}</strong><br/>
          Amount: $${(d.data.amount / 1000000).toFixed(1)}M<br/>
          Percentage: ${((d.data.amount / total) * 100).toFixed(1)}%
        `);
      
      tooltip
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 10) + "px");
    })
    .on("mouseout", function(event, d) {
      d3.select(this)
        .transition()
        .duration(200)
        .attr("transform", "translate(0,0)");
      
      d3.selectAll(".tooltip").remove();
    });

  // Add labels for larger slices
  arcs.filter(d => (d.data.amount / total) > 0.05)
    .append("text")
    .attr("transform", d => `translate(${labelArc.centroid(d)})`)
    .attr("dy", "0.35em")
    .attr("text-anchor", "middle")
    .style("font-size", "12px")
    .style("font-weight", "bold")
    .style("fill", "#374151")
    .text(d => `${((d.data.amount / total) * 100).toFixed(0)}%`);

  // Legend
  const legend = svg.append("g")
    .attr("class", "legend")
    .attr("transform", `translate(20, 30)`);

  const legendItems = legend.selectAll(".legend-item")
    .data(data)
    .enter().append("g")
    .attr("class", "legend-item")
    .attr("transform", (d, i) => `translate(0, ${i * 22})`);

  legendItems.append("rect")
    .attr("width", 15)
    .attr("height", 15)
    .attr("fill", d => color(d.category))
    .attr("rx", 2);

  legendItems.append("text")
    .attr("x", 22)
    .attr("y", 12)
    .style("font-size", "12px")
    .style("fill", "#374151")
    .text(d => d.category);

  legendItems.append("text")
    .attr("x", 22)
    .attr("y", 12)
    .attr("dx", "120px")
    .style("font-size", "11px")
    .style("fill", "#6b7280")
    .text(d => `$${(d.amount / 1000000).toFixed(0)}M`);

  // Title
  svg.append("text")
    .attr("x", width / 2)
    .attr("y", 20)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("font-weight", "bold")
    .style("fill", "#111827")
    .text("Budget Allocation by Category");

  // Total amount
  g.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", "-0.5em")
    .style("font-size", "14px")
    .style("font-weight", "bold")
    .style("fill", "#374151")
    .text("Total Budget");

  g.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", "1em")
    .style("font-size", "18px")
    .style("font-weight", "bold")
    .style("fill", "#111827")
    .text(`$${(total / 1000000).toFixed(0)}M`);

})();
</script>