{%- comment -%}
Topic Timeline Include
Usage: {% include topic-timeline.html topic="housing" years_back=2 %}
Parameters:
- topic: The tag to filter posts by (required)
- years_back: Number of years back to show (default: 2)
{%- endcomment -%}

{%- assign topic_filter = include.topic -%}
{%- assign years_back = include.years_back | default: 2 -%}
{%- assign current_year = site.time | date: '%Y' | plus: 0 -%}
{%- assign start_year = current_year | minus: years_back -%}

{%- comment -%} Filter posts by topic and date range {%- endcomment -%}
{%- assign topic_posts = site.posts | where_exp: "post", "post.tags contains topic_filter" -%}
{%- assign current_date = site.time | date: '%s' -%}
{%- assign seconds_per_year = 31536000 -%}
{%- assign cutoff_seconds = years_back | times: seconds_per_year -%}
{%- assign cutoff_timestamp = current_date | minus: cutoff_seconds -%}
{%- assign timeline_posts = topic_posts | sort: 'date' -%}

{%- if timeline_posts and timeline_posts.size > 0 -%}
<div class="topic-timeline bg-white border border-gray-200 rounded-2xl p-8 mb-8">
  <div class="mb-8">
    <h3 class="text-2xl font-bold text-gray-900 mb-2">{{ topic_filter | capitalize | replace: '-', ' ' }} Timeline</h3>
    <p class="text-gray-600">Stories and analysis over the past {{ years_back }} years</p>
  </div>

  <div class="relative">
    {%- comment -%} Timeline line {%- endcomment -%}
    <div class="absolute top-6 left-0 right-0 h-0.5 bg-gradient-to-r from-indigo-200 via-indigo-300 to-indigo-200"></div>
    
    {%- comment -%} Year markers {%- endcomment -%}
    <div class="relative flex justify-between mb-12">
      {%- for year_offset in (0..years_back) reversed -%}
        {%- assign year = current_year | minus: year_offset -%}
        <div class="flex flex-col items-center">
          <div class="w-4 h-4 bg-indigo-500 rounded-full border-2 border-white shadow-sm mb-2"></div>
          <span class="text-sm font-semibold text-gray-700">{{ year }}</span>
        </div>
      {%- endfor -%}
    </div>

    {%- comment -%} Timeline posts {%- endcomment -%}
    <div class="space-y-8">
      {%- assign posts_by_year = timeline_posts | group_by_exp: "post", "post.date | date: '%Y'" -%}
      
      {%- for year_group in posts_by_year -%}
        {%- assign year = year_group.name | plus: 0 -%}
        {%- if year >= start_year -%}
          <div class="relative">
            <div class="flex items-center gap-4 mb-6">
              <div class="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-semibold text-sm">
                {{ year_group.items.size }}
              </div>
              <h4 class="text-lg font-semibold text-gray-900">{{ year }}</h4>
            </div>
            
            <div class="ml-12 grid gap-6 sm:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
              {%- assign year_posts = year_group.items | sort: 'date' -%}
              {%- for post in year_posts -%}
                <article class="group relative bg-gray-50 rounded-xl border border-gray-100 hover:border-indigo-200 hover:shadow-md transition-all duration-200 overflow-hidden">
                  <div class="p-6">
                    <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
                      <time datetime="{{ post.date | date: '%Y-%m-%d' }}">
                        {{ post.date | date: '%B %-d, %Y' }}
                      </time>
                      {%- assign days_ago = site.time | date: '%s' | minus: post.date | date: '%s' | divided_by: 86400 -%}
                      {%- if days_ago <= 30 -%}
                        <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-[11px] font-medium text-green-700 ring-1 ring-inset ring-green-200">New</span>
                      {%- elsif days_ago <= 90 -%}
                        <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-[11px] font-medium text-blue-700 ring-1 ring-inset ring-blue-200">Recent</span>
                      {%- endif -%}
                    </div>
                    
                    <h5 class="text-base font-semibold text-gray-900 mb-3 group-hover:text-indigo-600 transition-colors">
                      <a href="{{ post.url }}" class="stretched-link">
                        {{ post.title }}
                      </a>
                    </h5>
                    
                    {%- if post.excerpt -%}
                      <p class="text-sm text-gray-600 mb-4 line-clamp-2">{{ post.excerpt | strip_html | truncatewords: 20 }}</p>
                    {%- endif -%}
                    
                    {%- if post.tags.size > 1 -%}
                      <div class="flex flex-wrap gap-1">
                        {%- for tag in post.tags limit: 3 -%}
                          {%- unless tag == topic_filter -%}
                            <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700">
                              {{ tag | replace: '-', ' ' }}
                            </span>
                          {%- endunless -%}
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  </div>
                </article>
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
  
  {%- comment -%} Summary stats {%- endcomment -%}
  <div class="mt-8 pt-6 border-t border-gray-200">
    <div class="flex items-center justify-between text-sm text-gray-600">
      <span>{{ timeline_posts.size }} post{% if timeline_posts.size != 1 %}s{% endif %} about {{ topic_filter | replace: '-', ' ' }}</span>
      <span>{{ years_back | plus: 1 }} year timeline</span>
    </div>
  </div>
</div>

{%- comment -%} Add custom CSS for line-clamp if not already available {%- endcomment -%}
<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .stretched-link::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1;
    content: "";
  }
</style>

{%- else -%}
<div class="topic-timeline bg-gray-50 border border-gray-200 rounded-2xl p-8 mb-8">
  <div class="text-center">
    <div class="text-4xl mb-4">ðŸ“…</div>
    <h3 class="text-xl font-semibold text-gray-900 mb-2">No {{ topic_filter | replace: '-', ' ' }} Timeline Yet</h3>
    <p class="text-gray-600">No posts found for this topic in the past {{ years_back }} years.</p>
  </div>
</div>
{%- endif -%}